<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="./src/css/lib/font-awesome-4.7.0/css/font-awesome.css">
    <title>Document</title>
    <style>
        @font-face {
            font-family: GenJyuuGothic-Medium;
            src: url("../../font/GenJyuuGothic-Medium.ttf")
        }
        
        @font-face {
            font-family: GenJyuuGothic-Light;
            src: url("../../font/GenJyuuGothic-Light.ttf")
        }
        
        div{
            font-family: GenJyuuGothic-Medium ;
        }

        * {
            padding: 0;
            margin: 0;
        }
        
        #banner {
            height: 10vh;
            background-color: #F7F5E4;
            box-shadow: 0 0 10px gray;
            position: relative;
            z-index: 2;
        }
        
        #block {
            display: flex;
        }
        
        #list {
            width: 15vw;
            height: 90vh;
            background-color: #F7F5E4;
            position: relative;
            display: flex;
            justify-content: start;
            flex-direction: column;
            align-items: center;
        }
        
        #content {
            width: 85vw;
            height: 90vh;
            background-color: #4B515F;
            position: relative;
        }
        
        #process {
            width: 40%;
            height: 35%;
            left: 0;
            top: 0;
            position: relative;
            z-index: 2;
            cursor: point
        }
        
        #monster {
            height: 70%;
            width: 50%;
            position: absolute;
            left: -8%;
            bottom: 10%;
            z-index: 4;
        }
        
        #outmission-block {
            height: 85%;
            width: 70%;
            padding: 10px;
            position: absolute;
            top: 11%;
            left: 25%;
            background-color: #787C81;
            border-radius: 12px;
            padding-top: 9%;
        }
        
        #mission-block {
            height: 100%;
            width: 100%;
            background-color: #787C81;
            overflow-y: scroll;
            position: relative;
        }
        
        .nothing{
            position: relative;
            margin: 0 auto;
            top:50%;
            transform: translate(30%,-70%);
            width:50%;
            height: 50%;
            background-image: url('./img/process/nothing.png');
            background-size: 50% 80%;
            background-repeat: no-repeat;
        }

        .nothing::after{
            position: absolute;
            content:'目前沒有任務...';
            color: #4B515F;
            top:100%;
            left:50%;
            transform: translateX(-100%);
            font-size:30px;
        }

        #request-btn {
            cursor: pointer;
            margin-top: 40%;
            width: 80%;
            height: 7%;
            position: relative;
            z-index: 5;
        }
        
        #process-btn {
            cursor: pointer;
            margin-top: 10%;
            width: 80%;
            height: 7%;
            position: relative;
            z-index:5;
        }
        #verify-btn {
            cursor: pointer;
            margin-top: 8%;
            width: 87%;
            height: 9%;
            position: relative;
            z-index:5;
        }
        #point-btn {
            cursor: pointer;
            margin-top: 5%;
            width: 87%;
            height: 9%;
            position: relative;
            z-index:5;
        }
        .mission {
            background-color: #F7F5E4;
            height: 19%;
            width: 85%;
            margin-bottom: 4%;
            position: relative;
            z-index: 3;
            border-radius: 10px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .mission>* {
            display: inline-block;
        }
        
        .icon {
            position: relative;
            margin-left: 2%;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .mission-name {
            font-family: GenJyuuGothic-Medium;
        }
        
        .mission-text {
            font-family: GenJyuuGothic-Light;
            display: flex;
            position: relative;
            z-index: 0;
            display: none;
        }
        
        .state1{
            display: flex;
        }
        .state2{
            display: flex;
        }

        .name_time {
            position: relative;
            left: 2%;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .point {
            position: absolute;
            right: 25%;
            text-align: center;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .status {
            position: absolute;
            top: 50%;
            right: 2%;
            transform: translateY(-50%);
        }
        
        .stateimage {
            width: 120px;
            height: 50px;
            position: relative;
        }

        
        #dummy {
            height: 15%;
        }
        
         ::-webkit-scrollbar {
            background-color: #C7C9BF;
            border-radius: 6px;
            position: absolute;
        }
        
         ::-webkit-scrollbar-thumb {
            background-color: #C7C9BF;
            border-radius: 6px;
        }
        
         ::-webkit-scrollbar-track {
            background-color: #999C9B;
            border-radius: 6px;
        }
        
         ::-webkit-scrollbar-thumb:hover {
            opacity: 0.8;
        }
        
         ::-webkit-resizer,
         ::-webkit-scrollbar-button,
         ::-webkit-scrollbar-corner {
            display: none;
        }
        
        .remain_img {
            margin-left: 4px;
            display: none;
        }

        .show_img{
            display: inline-block;
            width:30px;
            height:30px;
        }

        .canclick{
            cursor: pointer;
        }
        .mission_show{
            display: none;
        }
        .shift{
            position: relative;
            left:-30px;
            opacity: 0.5;
            margin-right: -30px;
            border-radius: 50%;
        }
        .bannerbutton {
    border-radius: 20px;
    text-decoration: none;
    border: none;
    cursor: pointer;
    background-color: #d0d9dc;
    font-family: GenJyuuGothic-Medium;
    color: #F7F6E3;
    padding: 1.2vh 2.5vh;
    color: #4B515F;
    outline: none;
    border: 0;
}

.bannerbutton:focus {
    outline: none;
}

.bannerbutton.active {
    background-color: #789fb3;
    color: #F7F6E3;
}
nav {
    position: absolute;
    margin-left: 4%;
    margin-right: 4%;
    bottom: 15%;
    z-index: 9;
    margin-top: 20%;
}

nav a {
    color: inherit;
    font-size: 19.5pt;
    font-family: GenJyuuGothic-Medium;
    bottom: 10px;
    text-decoration: none;
}

#logo {
    position: absolute;
    bottom: 25%;
}

#navbar {
    position: absolute;
    width: 92%;
    border-bottom: #799FB4 solid 3px;
    margin: 30px 4% 0px 4%;
}

nav>ul {
    position: absolute;
    list-style: none;
    right: 0;
    margin: 0;
    color: #799FB4;
    padding: 0;
    bottom: 5px;
}

li {
    margin: 0 10px;
}

.nav-bg {
    height: 10vh;
    width: 100%;
    background-color: #F7F6E4;
    position: relative;
    box-shadow: 0 0 10px gray ;
    z-index: 2;
}
.round{
    position:relative;
    width:50px;height:50px;
    border-radius:999em;
    background-color:#799FB4;
    border-color:#799FB4;
    border-style:solid;
    border-width:2px;
    cursor: pointer;
  }
  .nav-link {
    padding: 0;
}
.menubar{
    height:30px;
  width:100px;
  background:#b8bec4;
  font-size:1em;
  font-family:GenJyuuGothic-Medium;
  color:white !important;
  z-index:10;
  text-align:center;
  cursor: pointer;
}
.dropdown-toggle::after {
    display: none;
}
  .monster_icon{
    margin-right: 5px;
}
    </style>
</head>

<body>
    <div class="banner">
        <div class="nav-bg">
            <nav class="navbar " id="navbar">
                <a href="index.html" class="navbar-brand">
                    <span id="logo">
                        <img src="./img/s_topic.png" class="d-inline-block align-top">
                    </span>
                </a>
                <ul class="list-inline">
                    <li class="list-inline-item">
                        <button class="bannerbutton" onclick="location.href='game.html'" >任務地圖</button>
                    </li>
                    <li class="list-inline-item">
                        <button class="bannerbutton active" onclick="location.href='invite.html'">任務總覽</button>
                    </li>
                    <li class="list-inline-item">
                        <button class="bannerbutton" href="#"><img src="./img/monster_icon.png" height="20" width="auto" class="monster_icon">家事怪</button>
                    </li>
                    <li class="list-inline-item">
                        <div class="dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" >
                                <img id = "UserImg" class="round" alt="" >
                            </a>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuLink" style="min-width: auto; padding: 0;">
                                <a class="dropdown-item menubar" href="user.html" style="padding: 0;"><i class="fa fa-cog" aria-hidden="true"></i> 個人資料</a>
                                <a class="dropdown-item menubar" style="padding: 0;" id = "bar2"><i class="fa fa-sign-out" aria-hidden="true"></i> 登出</a>
                            </div>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    <div id="block">
        <div id="list">
            <img src="./img/process/list-request.png" id="request-btn" alt="">
            <img src="./img/process/list-process.png" id="process-btn" alt=" ">
            <img src="./img/process/list-verify.png" id="verify-btn" alt=" ">
            <img src="./img/list-point.png" id="point-btn" alt=" ">
        </div>

        <div id="content">
            <img src="./img/process/process.svg" id="process" alt=" ">
			<img src="./img/process/monster.svg" id="monster" alt=" ">
            <div id="outmission-block">

                <div id="mission-block" class="app">
                    <div class="exchange"></div>
                <template v-for="(task,index) in tasks">
                    <div class="mission" :class="{mission_show:task.state==3}">
                        <img :src="task.houseworkicon" class="icon" alt="">
                        <div class="name_time">
                            <div class="mission-name">{{task.content}}</div>
                            <div class="mission-text" :class="{state1:task.state==1||task.state==4}">剩餘時間: {{task.remain}}</div>
                            <div class="mission-text" :class="{state2:task.state==2}">審核狀況: 
                                <template v-for="(member,index) in task.verify">
                                    <img src="./img/process/yes.png" class="remain_img" :class="{show_img:member.state==1}">
                                    <img src="./img/process/no.png" class="remain_img" :class="{show_img:member.state==0}">
                                    <img :src="member.icon" class="show_img shift">
                                </template>
                            </div>
                        </div>

                        <div class="point">
                            <img src="./img/process/point.png" class="point_icon" alt="">
                            <div>{{task.point}}p</div>
                        </div>

                        <div class="status">
                            <img v-bind:src="task.stateimage" class="stateimage" :class="{canclick:task.state==1||task.state==4}"  v-on:click=changeState(index) alt="">
                        </div>

                    </div>
                </template>


			

                </div>


            </div>
        </div>

    </div>
</body>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="./src/js/id.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js " integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k " crossorigin="anonymous "></script>
<script>
window.fbAsyncInit = function() {
        FB.init({
            appId: myAppId,
            xfbml: true,
            version: 'v7.0'
        });
        FB.AppEvents.logPageView();
    };
    // Load the SDK asynchronously
    (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) { return; }
        js = d.createElement(s);
        js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

$('#process-btn').click(function(e){
        location.href = './process.html';
    })
    $('#request-btn').click(function(e){
        location.href = './invite.html';
    })
    $('#verify-btn').click(function(e){
        location.href = './verify.html';
    })
    $('#point-btn').click(function(e){
        location.href = './point.html';
    })
window.onload = function() {
    $.post('./tasks/progress', {
        account:localStorage.getItem('account')
    }, (res) => {
        $.get('./tasks/memberlength',{classcode:localStorage.getItem('classcode')},res2=>{
            settasks(res,res2.length);
        })
    });
        var account = localStorage.getItem("account");
        $.get('./users/find/' + account, {}, (res) => {
            document.getElementById("UserImg").style.backgroundImage= `url(${res.icon})`;
            localStorage.setItem("classcode", res.classcode);
        });
        
    };


function settasks(res,member_num){
    console.log(member_num)
    resultdate = []
    res.forEach((item) => {
        var date = item.date.split('/');
        var year = date[2];
        var day = date[1];
        var month = date[0];
        var time = item.time.split(' ');
        var hour = parseInt(time[0].split(':'));
        var hour = (time[1][0] == 'P') ? hour + 12 : hour;
        var missiondate = new Date(year, month - 1, day, hour, 00, 00);
        resultdate.push(missiondate)
    })
    var content = localStorage.getItem('account')
    var accept = 0;
    var refuse = 0;
    var standard = member_num/2 + 1;
    var success = 0;
    for (var i = 0; i < res.length; i++) {
            accept = 0;
            refuse = 0;
            res[i].date = resultdate[i];
            res[i]["remain"] = 0;
            for(var j = 0;j < res[i]["participate"].length;j++){
                if(content == res[i].participate[j].id ){
                    res[i]["state"] = res[i].participate[j].state
                    if(res[i]["state"] == 1){
                        res[i]["stateimage"] = "./img/process/complete.png"
                    }
                    else if (res[i]["state"] == 2){
                        if( res[i].verify.length==0){
                            res[i]["stateimage"] = "./img/process/judge.png";
                        }
                    }
                    else if (res[i]["state"] == 3){
                        success = success+1
                    }
                    else if (res[i]["state"] == 4){
                        res[i]["stateimage"] = "./img/process/again.png"
                    }
                }
            }

        housework = res[i].content 
        if(housework.includes('洗碗')){
            res[i]["houseworkicon"] =  './img/housework/bowl.png'
        }
        else if (housework.includes('垃圾')){
            res[i]["houseworkicon"] = './img/housework/garbage.png'       
        }
        else if (housework.includes('衣服')){
            res[i]["houseworkicon"] = './img/housework/cloth.png'       
        }
        else if (housework.includes('掃地')){
            res[i]["houseworkicon"] = './img/housework/sweep.png'       
        }
        else if (housework.includes('拖地')){
            res[i]["houseworkicon"] = './img/housework/mop.png'       
        }
        else if (housework.includes('廁所')){
            res[i]["houseworkicon"] = './img/housework/toilet.png'       
        }
        else{
            res[i]["houseworkicon"] = './img/housework/share.png'
        }


    
    }

    if(res.length-success == 0){
        $('.exchange').addClass('nothing')
    }
    else{
        if($('.exchange').hasClass('nothing')){
            $('.exchange').removeClass('nothing')
        }
    }
    vueinstance.tasks = res;
    vueinstance.success = success;
}

function find_objid(content,index){
    console.log(content)
    for(var i = 0;i <vueinstance.tasks[index].participate.length;i++){
        if(vueinstance.tasks[index].participate[i].id == content){
            console.log(i)
            return vueinstance.tasks[index].participate[i]._id
        }
    }
}

$(document).on('click',"#bar2",function(){
    FB.getLoginStatus(function(response) {
            if (response.status === 'connected') {
                FB.logout(function(response) {
                    // this part just clears the $_SESSION var
                    // replace with your own code
                    console.log(response)
                    location.href='./index.html'
                });
            }
            else{
                localStorage.clear();
                location.href='./index.html'
            }
        });
})
    var tasks = [];
    var vueinstance = new Vue({
        el: '.app',
        data: {
            tasks:tasks,
            success:0
        },
        methods: {
            changeState: function(index){
                console.log(index)
                if(this.tasks[index]["state"] == 1){
                    console.log(find_objid(localStorage.getItem('account'),index))
                    console.log(localStorage.getItem('account'))
                    $.post('./tasks/changestate:none', {
                            id: find_objid(localStorage.getItem('account'),index),
                            state:2,
                            _id:this.tasks[index]["_id"]
                    }, (res) => {
                        console.log(res)
                        this.tasks[index]["stateimage"] = "./img/process/judge.png"
                        this.tasks[index]["state"] = 2
                        this.$forceUpdate()
                    });
                }
                else if(this.tasks[index]["state"] == 4){
                    $.post('./tasks/changestateclear', {
                            id: find_objid(localStorage.getItem('account'),index),
                            state:2,
                            _id:this.tasks[index]["_id"]
                    }, (res) => {
                        console.log(res)
                        this.tasks[index]["stateimage"] = "./img/process/judge.png"
                        this.tasks[index]["state"] = 2;
                        for(var i = 0;i <  this.tasks[index]["verify"].length;i++){
                            if(this.tasks[index]["verify"][i]["state"]==0)
                                this.tasks[index]["verify"][i]["state"] = 2;
                        }

                        this.$forceUpdate()
                    });                   
                }
            },
            remaintime: function(index) {
                var nowTime = new Date();
                var restSec = this.tasks[index].date.getTime() - nowTime.getTime();
                var day = parseInt(restSec / (60 * 60 * 24 * 1000));
                var hour = parseInt(restSec / (60 * 60 * 1000) % 24);
                var minu = parseInt(restSec / (60 * 1000) % 60);
                var sec = parseInt(restSec / 1000 % 60);
                var timestr = day + "天" + hour + "時" + minu + "分" + sec + "秒"
                if (restSec > 0) {
                    setTimeout(this.remaintime, 1000, index);
                    this.$set(this.tasks[index], 'remain', timestr);
                    this.$forceUpdate()
                } else {
                    if(this.tasks[index]["state"] == 1){
                        $.post('./tasks/expired', {
                            id: this.tasks[index]._id
                        }, (res) => {
                            console.log(res);
                        });
                        this.$delete(this.tasks, index)
                    }
                }
            }
        },
        watch: {
            tasks: {
                handler() {
                    if (this.tasks.length != 0) {
                        for (var i = 0; i < this.tasks.length; i++) {
                            this.remaintime(i);
                        }
                    }
                    else{

                    }
                },
            }
        }
    })
</script>
</html>